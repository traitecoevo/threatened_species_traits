---
title: "Threatened species script"
format: html
editor: visual
embed-resources: true
knitr:
  opts_knit:
    root.dir: "C:/Users/Lizzy/Documents/GitHub/threatened_species_traits"
editor_options: 
  chunk_output_type: console
---

# Setup and data extraction

## load libraries, build database

-   open/merge AusTraits and attributes in threatened species database

```{r, echo=FALSE, results='hide', message=FALSE, warning=FALSE}
library(tidyverse)
library(remake)
library(kableExtra)
library(austraits)
library(APCalign)
library(traits.build)

path <- "../traits.build/"
devtools::load_all(path)

resources <- APCalign::load_taxonomic_resources()

austraits <- readRDS("C:/Users/Lizzy/Documents/GitHub/threatened_species_traits/ignore/austraits/austraits_20250402.rds")

source("C:/Users/Lizzy/Documents/GitHub/threatened_species_traits/R/custom_R_code.R")
source("C:/Users/Lizzy/Documents/GitHub/threatened_species_traits/R/extra_functions.R")

setwd("C:/Users/Lizzy/Documents/GitHub/threatened_species_traits")
build_setup_pipeline(method = "remake", database_name = "threatened_species")

threatened_species <- remake::make("threatened_species")

# create combined database with both data sources
all_traits <- austraits %>% bind_databases(threatened_species)
```

## create dataframes for key traits

- create dataframes from merged database for any trait suspected to be relevant for any threats

### for categorical traits, source conversions

- read in files that indicate conversions between categorical values and a numeric equivalent, to allow linear models to be run to look at trait - susceptibility correlations

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# open files with categorical to numeric conversions for categorical traits
life_history_scores <- read_csv("~/Github/threatened_species_traits/data_extras/life_history.csv")
dispersers_scores <- read_csv("~/Github/threatened_species_traits/data_extras/dispersers.csv")
resprouting_capacity_scores <- read_csv("~/Github/threatened_species_traits/data_extras/resprouting_capacity.csv")
phytophthora_cinnamomi_susceptibility_scores <- read_csv("~/Github/threatened_species_traits/data_extras/phytophthora_cinnamomi_susceptibility_scores.csv")
nitrogen_fixing_scores <- read_csv("~/Github/threatened_species_traits/data_extras/nitrogen_fixing_scores.csv")
leaf_hairs_adult_leaves_scores <- read_csv("~/Github/threatened_species_traits/data_extras/leaf_hairs_adult_leaves_scores.csv")
leaf_glaucousness_scores <- read_csv("~/Github/threatened_species_traits/data_extras/leaf_glaucousness_scores.csv")
plant_spinescence_scores <- read_csv("~/Github/threatened_species_traits/data_extras/plant_spinescence_scores.csv")
plant_goat_toxicity_scores <- read_csv("~/Github/threatened_species_traits/data_extras/plant_goat_toxicity_scores.csv")
plant_goat_palatability_scores <- read_csv("~/Github/threatened_species_traits/data_extras/plant_goat_palatability_scores.csv")
plant_growth_form_scores <- read_csv("~/Github/threatened_species_traits/data_extras/plant_growth_form_scores.csv")
soil_type_scores <- read_csv("~/Github/threatened_species_traits/data_extras/soil_type_scores.csv")
geologic_substrate_scores <-  read_csv("~/Github/threatened_species_traits/data_extras/geologic_substrate_scores.csv")


life_history_scores %>% filter(!str_detect(value, " ")) %>% arrange(life_history) %>% rename(`categorical value` = value, `numeric score assigned` = life_history)  %>% kable(caption = "life history values") %>% kable_classic()

plant_growth_form_scores %>% filter(!str_detect(value, " ")) %>% arrange(plant_growth_form) %>% rename(`categorical value` = value, `numeric score assigned` = plant_growth_form)  %>% kable(caption = "plant growth form values") %>% kable_classic()

resprouting_capacity_scores %>% filter(!str_detect(value, " ")) %>% arrange(resprouting_capacity) %>% rename(`categorical value` = value, `numeric score assigned` = resprouting_capacity)  %>% kable(caption = "resprouting capacity values") %>% kable_classic()

dispersers_scores %>% filter(!str_detect(value, " ")) %>% arrange(dispersers_score) %>% rename(`categorical value` = value, `numeric score assigned` = dispersers_score)  %>% kable(caption = "dispersal trait values") %>% kable_classic()

nitrogen_fixing_scores %>% filter(!str_detect(value, " ")) %>% arrange(nitrogen_fixing) %>% rename(`categorical value` = value, `numeric score assigned` = nitrogen_fixing)  %>% kable(caption = "nitrogen fixing values") %>% kable_classic()

leaf_glaucousness_scores %>% filter(!str_detect(value, " ")) %>% arrange(leaf_glaucousness) %>% rename(`categorical value` = value, `numeric score assigned` = leaf_glaucousness)  %>% kable(caption = "leaf glaucousness values") %>% kable_classic()

leaf_hairs_adult_leaves_scores %>% filter(!str_detect(value, " ")) %>% arrange(leaf_hairs_adult_leaves) %>% rename(`categorical value` = value, `numeric score assigned` = leaf_hairs_adult_leaves)  %>% kable(caption = "leaf hair values") %>% kable_classic()

plant_spinescence_scores %>% filter(!str_detect(value, " ")) %>% arrange(plant_spinescence) %>% rename(`categorical value` = value, `numeric score assigned` = plant_spinescence)  %>% kable(caption = "plant spinescence values") %>% kable_classic()

plant_goat_toxicity_scores %>% filter(!str_detect(value, " ")) %>% arrange(plant_goat_toxicity) %>% rename(`categorical value` = value, `numeric score assigned` = plant_goat_toxicity)  %>% kable(caption = "plant goat toxicity values") %>% kable_classic()

plant_goat_palatability_scores %>% filter(!str_detect(value, " ")) %>% arrange(plant_goat_palatability) %>% rename(`categorical value` = value, `numeric score assigned` = plant_goat_palatability)  %>% kable(caption = "plant goat palatability values") %>% kable_classic()
```

### extract categorical traits from database

- extract all available values for categorical traits identified as 1) having sufficient coverage **AND** 2) being plausible relevant to predict the susceptibility of one of the threats
- for each trait, merge in numeric conversions
- for each taxon, take the mean of all available values 

```{r, echo=FALSE, results='hide', message=FALSE, warning=FALSE}
life_history <- all_traits$traits %>% 
  filter(trait_name == "life_history")  %>% 
  left_join(life_history_scores, by = join_by(value)) %>%
  select(taxon_name, life_history) %>%
  group_by(taxon_name) %>%
  mutate(life_history = mean(life_history)) %>%
  ungroup() %>%
  distinct()

dispersers <- all_traits$traits %>% 
  filter(trait_name %in% c("dispersal_syndrome", "dispersers"))  %>% 
  left_join(dispersers_scores, by = join_by(trait_name, value)) %>%
  filter(!is.na(dispersers_score)) %>%
  select(taxon_name, dispersers_score) %>%
  group_by(taxon_name) %>%
  mutate(dispersers_score = mean(as.numeric(dispersers_score))) %>%
  ungroup() %>%
  distinct()

resprouting_capacity <- all_traits$traits %>% 
  filter(trait_name %in% c("resprouting_capacity"))  %>% 
  left_join(resprouting_capacity_scores, by = join_by(trait_name, value)) %>%
  filter(!is.na(resprouting_capacity)) %>%
  select(taxon_name, resprouting_capacity) %>%
  group_by(taxon_name) %>%
  mutate(resprouting_capacity = mean(as.numeric(resprouting_capacity))) %>%
  ungroup() %>%
  distinct()

nitrogen_fixing <- all_traits$traits %>% 
  filter(trait_name %in% c("nitrogen_fixing"))  %>% 
  left_join(nitrogen_fixing_scores, by = join_by(trait_name, value)) %>%
  filter(!is.na(nitrogen_fixing)) %>%
  select(taxon_name, nitrogen_fixing) %>%
  group_by(taxon_name) %>%
  mutate(nitrogen_fixing = mean(as.numeric(nitrogen_fixing))) %>%
  ungroup() %>%
  distinct()

plant_growth_form <- all_traits$traits %>% 
  filter(trait_name == "plant_growth_form")  %>% 
  left_join(plant_growth_form_scores, by = join_by(trait_name, value)) %>%
  select(taxon_name, plant_growth_form) %>%
  group_by(taxon_name) %>%
  mutate(plant_growth_form = mean(plant_growth_form)) %>%
  ungroup() %>%
  distinct()

leaf_hairs_adult_leaves <- all_traits$traits %>% 
  filter(trait_name == "leaf_hairs_adult_leaves")  %>% 
  left_join(leaf_hairs_adult_leaves_scores, by = join_by(trait_name, value)) %>%
  select(taxon_name, leaf_hairs_adult_leaves) %>%
  group_by(taxon_name) %>%
  mutate(leaf_hairs_adult_leaves = mean(leaf_hairs_adult_leaves)) %>%
  ungroup() %>%
  distinct()

leaf_glaucousness <- all_traits$traits %>% 
  filter(trait_name == "leaf_glaucousness")  %>% 
  left_join(leaf_glaucousness_scores, by = join_by(trait_name, value)) %>%
  select(taxon_name, leaf_glaucousness) %>%
  group_by(taxon_name) %>%
  mutate(leaf_glaucousness = mean(leaf_glaucousness)) %>%
  ungroup() %>%
  distinct()

fruit_fleshiness <- all_traits$traits %>% 
  filter(trait_name == "fruit_fleshiness") %>%
  mutate(fruit_fleshiness = case_when(
    value == "dry" ~ 0,
    value == "fleshy" ~ 1,
    value == "dry fleshy" ~ 0.5
  )) %>%
  select(taxon_name, fruit_fleshiness) %>%
  group_by(taxon_name) %>%
  mutate(fruit_fleshiness = mean(fruit_fleshiness)) %>%
  ungroup() %>%
  distinct()

plant_spinescence <- all_traits$traits %>% 
  filter(trait_name == "plant_spinescence")  %>% 
  left_join(plant_spinescence_scores, by = join_by(trait_name, value)) %>%
  select(taxon_name, plant_spinescence) %>%
  group_by(taxon_name) %>%
  mutate(plant_spinescence = mean(plant_spinescence)) %>%
  ungroup() %>%
  distinct()

plant_goat_toxicity <- all_traits$traits %>% 
  filter(trait_name == "plant_goat_toxicity")  %>% 
  left_join(plant_goat_toxicity_scores, by = join_by(trait_name, value)) %>%
  select(taxon_name, plant_goat_toxicity) %>%
  group_by(taxon_name) %>%
  mutate(plant_goat_toxicity = mean(plant_goat_toxicity)) %>%
  ungroup() %>%
  distinct()

plant_goat_palatability <- all_traits$traits %>% 
  filter(trait_name == "plant_goat_palatability") %>% 
  left_join(plant_goat_palatability_scores, by = join_by(trait_name, value)) %>%
  select(taxon_name, plant_goat_palatability) %>%
  group_by(taxon_name) %>%
  mutate(plant_goat_palatability = mean(plant_goat_palatability)) %>%
  ungroup() %>%
  distinct() %>%
  plant_goat_palatability

# sometimes trait value is scored for the entire genus and need to map to species values
plant_goat_palatability_genera <- plant_goat_palatability %>%
  filter(!str_detect(taxon_name, " ")) %>%
  rename(genus = taxon_name) %>%
  left_join(resources$APC %>% filter(taxonomic_status == "accepted", taxon_rank == "species") %>% select(genus, taxon_name = canonical_name))

plant_goat_palatability <- plant_goat_palatability %>%
  filter(str_detect(taxon_name, " ")) %>%
  bind_rows(plant_goat_palatability_genera)
```

### extract numeric traits from database

- extract all available values for numeric traits identified as 1) having sufficient coverage **AND** 2) being plausible relevant to predict the susceptibility of one of the threats

- for each taxon, take the mean of all available values using a weighted mean function developed for AusTraits, which first takes the mean of multiple individual values collected at a single site; then the mean of values from all population; and at the end also considers values extracted from floras (and similar publications) that refer to the entire species

- the function used is called `austraits_weighted_means` 

```{r, echo=FALSE, results='hide', message=FALSE, warning=FALSE}
seed_dry_mass <- all_traits %>%
  austraits::extract_trait("seed_dry_mass") %>%
  austraits_weighted_means("seed_dry_mass") %>%
  filter(taxon_name %in% resources$`APC list (accepted)`$canonical_name) %>%
  select(taxon_name, seed_dry_mass = mean)

leaf_mass_per_area <- all_traits %>%
  austraits::extract_trait("leaf_mass_per_area") %>%
  austraits_weighted_means("leaf_mass_per_area") %>%
  filter(taxon_name %in% resources$`APC list (accepted)`$canonical_name) %>%
  select(taxon_name, leaf_mass_per_area = mean)

plant_height <- all_traits %>%
  austraits::extract_trait("plant_height") %>%
  austraits_weighted_means("plant_height") %>%
  filter(taxon_name %in% resources$`APC list (accepted)`$canonical_name) %>%
  select(taxon_name, plant_height = max)

leaf_length <- all_traits %>%
  austraits::extract_trait("leaf_length") %>%
  austraits_weighted_means("leaf_length") %>%
  filter(taxon_name %in% resources$`APC list (accepted)`$canonical_name) %>%
  select(taxon_name, leaf_length = mean)

leaf_nitrogen <- all_traits %>%
  austraits::extract_trait("leaf_N_per_dry_mass") %>%
  austraits_weighted_means("leaf_N_per_dry_mass") %>%
  filter(taxon_name %in% resources$`APC list (accepted)`$canonical_name) %>%
  select(taxon_name, leaf_N_per_dry_mass = mean)

leaf_phosphorus <- all_traits %>%
  austraits::extract_trait("leaf_P_per_dry_mass") %>%
  austraits_weighted_means("leaf_P_per_dry_mass") %>%
  filter(taxon_name %in% resources$`APC list (accepted)`$canonical_name) %>%
  select(taxon_name, leaf_P_per_dry_mass = mean)

reproductive_maturity <- all_traits %>%
  austraits::extract_trait("reproductive_maturity") %>%
  austraits_weighted_means("reproductive_maturity") %>%
  filter(taxon_name %in% resources$`APC list (accepted)`$canonical_name) %>%
  select(taxon_name, reproductive_maturity = mean)

seedbank_longevity <- all_traits %>%
  austraits::extract_trait("seedbank_longevity") %>%
  austraits_weighted_means("seedbank_longevity") %>%
  filter(taxon_name %in% resources$`APC list (accepted)`$canonical_name) %>%
  select(taxon_name, seedbank_longevity = mean)

leaf_water_content_per_area <- all_traits %>%
  austraits::extract_trait("leaf_water_content_per_area") %>%
  austraits_weighted_means("leaf_water_content_per_area") %>%
  filter(taxon_name %in% resources$`APC list (accepted)`$canonical_name) %>%
  select(taxon_name, leaf_water_content_per_area = mean)
```

### extract non-trait attributes from database - for susceptibility scoring, not for trait correlations

- there are attributes of a species that aren't "traits" but are known to affect a species susceptibility to various threats

- these include:
  1. habitat (vegetation association and moisture)
  2. soil type (mainly soil textural terms) - under Phytophthora for now
  3. underlying geologic substrate  - under Phytophthora for now
  4. population size (not merged in yet because too little data)
  5. population count (not merged in yet because too little data)

```{r, echo=FALSE, results='hide', message=FALSE, warning=FALSE}
habitat <- all_traits$traits %>%
  filter(trait_name == "habitat") %>%
  select(taxon_name, habitat = value) %>%
  group_by(taxon_name) %>%
  mutate(habitat = paste0(habitat, collapse = " ")) %>%
  ungroup() %>%
  distinct()

habitat_moisture <- all_traits$traits %>%
  filter(trait_name == "habitat_moisture") %>%
  select(taxon_name, habitat_moisture = value) %>%
  group_by(taxon_name) %>%
  mutate(habitat_moisture = paste0(habitat_moisture, collapse = " ")) %>%
  ungroup() %>%
  distinct()
```

### create tables partially ranking soils, geologic substrates by suscepibility

```{r, echo=FALSE, results='hide', message=FALSE, warning=FALSE}
# clay soils assigned risk of 0.5; 
# all others 1; not a lot of evidence for this, but a few studies suggesting sandy soils worst effected
# quite possibly this is actually about soil nutrient content, not actually texture
soil_type <- all_traits$traits %>%
  filter(trait_name == "soil_type") %>%
  select(taxon_name, value) %>%
  tidyr::separate_longer_delim(value, delim = " ") %>%
  dplyr::left_join(soil_type_scores) %>%
  select(-value, -trait_name) %>%
  group_by(taxon_name) %>%
  mutate(soil_score = mean(soil_score)) %>%
  ungroup() %>%
  distinct(taxon_name, soil_score)

# high pH soils (limestone, other calcareous soils) & and saline soils assigned 0 risk; all others 1
# take mean for each species based on all terms in database
geologic_substrate <- all_traits$traits %>%
  filter(trait_name == "geologic_substrate") %>%
  select(taxon_name, value) %>%
  tidyr::separate_longer_delim(value, delim = " ") %>%
  dplyr::left_join(geologic_substrate_scores) %>%
  select(-value, -trait_name) %>%
  group_by(taxon_name) %>%
  mutate(geologic_substrate_score = mean(geologic_substrate_score)) %>%
  ungroup() %>%
  distinct(taxon_name, geologic_substrate_score) %>%
  dplyr::arrange(geologic_substrate_score)
```

# Phytophthora cinnamomi

### Are any traits good predictors?

- Check if trait correlations exist for taxa where susceptibility is already known.

#### - create dataframe

- create table with susceptibility, trait values for taxa with known *Phytophthora cinnamomi* susceptibility

```{r, results='hide', message=FALSE, warning=FALSE}
phytophthora_cinnamomi_susceptibility <- (all_traits %>% join_taxa(vars = "family"))$traits %>%
  filter(trait_name == "phytophthora_cinnamomi_susceptibility") %>%
  select(taxon_name, family, value) %>%
  left_join(phytophthora_cinnamomi_susceptibility_scores, by = join_by(value)) %>%
  group_by(taxon_name) %>%
  mutate(
    phytophthora_cinnamomi_susceptibility_score = mean(phytophthora_cinnamomi_susceptibility_score, na.rm = T)) %>% 
  ungroup() %>%
  distinct() %>% 
  left_join(nitrogen_fixing, by = "taxon_name") %>%
  left_join(dispersers, by = "taxon_name") %>%
  left_join(life_history, by = "taxon_name") %>%
  left_join(leaf_glaucousness, by = "taxon_name") %>%
  left_join(leaf_hairs_adult_leaves, by = "taxon_name") %>%
  left_join(seed_dry_mass, by = "taxon_name") %>%
  left_join(leaf_mass_per_area, by = "taxon_name") %>%
  left_join(fruit_fleshiness, by = "taxon_name") %>%
  left_join(resprouting_capacity, by = "taxon_name") %>%
  left_join(leaf_phosphorus, by = "taxon_name") %>%
  left_join(leaf_nitrogen, by = "taxon_name") %>%
  left_join(leaf_length, by = "taxon_name") %>%
  left_join(plant_height, by = "taxon_name") %>%
  left_join(soil_type, by = "taxon_name") %>%
  left_join(geologic_substrate, by = "taxon_name")
```

#### - check for trait correlations

-   identify strong susceptibility-trait correlations for taxa with known susceptibility

-   Note: 

    1. Not considering traits that might matter but are entirely linked to taxonomy (i.e. types of roots/root associations)
    2. Not considering traits that are known to matter, but are known for so few species to be useless as predictors (constitutive and induced responses to infection; concentration of secondary metabolites in plant)
    
- In the output:

    1. a positive coefficient indicates a higher trait value in more susceptible taxa
    2. for numeric traits, the magnitude of the coefficient indicates the change in response variable for a "1 unit" increase in susceptibility, where susceptibility is on a scale of 0--3.
    3. for numeric traits, the magnitude of the coefficient must be intepreted in conjunction with knowing the scaling for the response variable - different for each trait; the susceptibility is on a scale of 0--3.
    4. Also in this chart are correlations with soil type/texture and geologic substrate. As also indicated in the literature, it isn't that taxa growing of "resistant substrates/soils" are themselves resistant, but that Phytophthora doesn't survive in these locations. Therefore, this information can be used to asses the **RISK** of a species to Phytophthora, but not its **SUSCEPTIBILITY** to Phytophthora.

```{r, echo=FALSE, message=FALSE, warning=FALSE}
correlations_with_possible_traits <- tibble(
  trait = NA_character_,
  coeff = NA_character_,
  r2 = NA_character_, 
  p_value = NA_character_,
  n = NA_character_,
)

for (var in c("life_history", "dispersers_score", "nitrogen_fixing", "resprouting_capacity", "seed_dry_mass", "leaf_mass_per_area", "fruit_fleshiness", "plant_height", "leaf_length", "leaf_glaucousness", "leaf_hairs_adult_leaves", "leaf_N_per_dry_mass", "leaf_P_per_dry_mass", "soil_score", "geologic_substrate_score")) {
  
  data_tmp <- phytophthora_cinnamomi_susceptibility %>% filter(!is.na(phytophthora_cinnamomi_susceptibility[[var]]),
                                         !is.na(phytophthora_cinnamomi_susceptibility_score))
  
  linearmodel_var <- lm(data_tmp[[var]] ~ phytophthora_cinnamomi_susceptibility_score , data = data_tmp)
  
  summary(linearmodel_var)[4] %>% as.data.frame() %>% select(4) -> p
  summary(linearmodel_var)[4] %>% as.data.frame() %>% select(1) -> coeff
  
  new_row <- c(
    trait = var, 
    r2= round(summary(linearmodel_var)$r.squared,4), 
    p_value = round(p[2,1],4),
    coeff = round(coeff[2,1],3),
    n = nrow(data_tmp)
      ) %>% 
    t() %>%
    as.data.frame()
  
  correlations_with_possible_traits <- correlations_with_possible_traits %>%
    bind_rows(new_row)
}

correlations_with_possible_traits <- correlations_with_possible_traits %>% 
  arrange(-as.numeric(r2)) %>% 
  filter(!is.na(trait))


Phytophthora_kable_table <- correlations_with_possible_traits %>% kableExtra::kable(caption = "Correlation between Phytophthora susceptibililty and trait value, for species with known susceptibility")

kableExtra::kable_classic(Phytophthora_kable_table) %>%
  kableExtra::kable_styling(full_width = FALSE)
```

### How important is taxonomy? (vs traits...)

- Family matters more than traits
- Although some moderate correlations with traits exist, knowing a plant's family is a much better predictor of its susceptibility - at least visually

```{r, echo=FALSE, message=FALSE, warning=FALSE}

by_family <- phytophthora_cinnamomi_susceptibility %>%
  filter(!is.na(phytophthora_cinnamomi_susceptibility_score)) %>%
  group_by(family) %>%
  mutate(
    phytophthora_cinnamomi_susceptibility_score = mean(phytophthora_cinnamomi_susceptibility_score),
    taxa_scored_per_family = n()
    ) %>%
  ungroup() %>%
  distinct(family, taxa_scored_per_family, phytophthora_cinnamomi_susceptibility_score) %>%
  filter(taxa_scored_per_family > 5, !is.na(family)) %>%
  arrange(-phytophthora_cinnamomi_susceptibility_score)

family_histograms <- phytophthora_cinnamomi_susceptibility %>%
  filter(family %in% by_family$family) %>%
  filter(!is.na(phytophthora_cinnamomi_susceptibility_score)) %>%
  left_join(by_family %>% select(family, taxa_scored_per_family)) %>%
  group_by(family, phytophthora_cinnamomi_susceptibility_score) %>%
  mutate(
    prop_taxa = n() / taxa_scored_per_family,
    count_taxa = n()
    ) %>%
  ungroup() %>%
  distinct(family, phytophthora_cinnamomi_susceptibility_score, prop_taxa, count_taxa, taxa_scored_per_family) %>%
  arrange(family, phytophthora_cinnamomi_susceptibility_score) %>%
  mutate(
    family2 = paste0(family, " (n=", taxa_scored_per_family,")")
  )

ggplot(data = family_histograms) +
  geom_col(aes(x = phytophthora_cinnamomi_susceptibility_score, y = prop_taxa), width = .9) +
  facet_wrap(~family2) +
  theme_minimal() +
  theme(
    axis.line.x.bottom = element_line(),
    axis.line.y.left = element_line()
  ) +
  ylab("prop. taxa tested (proportion within taxa tested within each family") +
  xlab("Phytophthora cinnamomi susceptibility score (higher = more susceptible)")
```

### Assign risks to all taxa

- first steps are based on taxonomy and habitat: 
  1. for taxa from well-sampled families, include a taxonomic adjustment factor
  *as a starting point, have the average risk within the family, rescaled from 0--1.*
  2. taxa that live on calcareous (limestone, basic, alkaline) soils are not susceptible
  3. plants that live on clay soils are less susceptible - but this needs to be a down-weighted effect
  
- second steps will be to adjust these susceptibilities based on traits
  1. need to decide on r^2 threshold, below which the uncertainty is too great to include (possibly true for all traits where we have data!)
  2. it would be great to have information on Proteaceae which explicitly do not form cluster roots or Ericaceae that do not form root hairs (or have very transient root hairs); also possible that cord roots increase susceptibility in Daviseia; but that doesn't seem to be available

```{r}
phytophthora_assigned_risk <- resources$APC %>% 
  filter(taxonomic_status == "accepted") %>%
  filter(taxon_rank %in% c("species", "subspecies", "variety")) %>%
  select(taxon_name = canonical_name, genus, family, taxon_distribution)

phytophthora_assigned_risk <- phytophthora_assigned_risk %>%
  left_join(by_family %>% rename(family_average_score = phytophthora_cinnamomi_susceptibility_score), by = "family") %>%
  left_join(geologic_substrate %>% rename(substrate_risk = geologic_substrate_score), by = "taxon_name") %>%
  left_join(soil_type %>% rename(soil_texture_risk = soil_score), by = "taxon_name") %>%
  left_join(resprouting_capacity, by = "taxon_name") %>%
  left_join(leaf_phosphorus, by = "taxon_name") %>%
  left_join(leaf_nitrogen, by = "taxon_name") %>%
  left_join(leaf_mass_per_area, by = "taxon_name") %>%
  mutate(
    family_raw_risk = family_average_score/3
  )
```

# Myrtle rust

### Are any traits good predictors?

- Check if trait correlations exist for taxa where susceptibility is already known.

#### - create dataframe

- create table with susceptibility, trait values for taxa with known susceptibility

```{r, results='hide', message=FALSE, warning=FALSE}
myrtle_rust_susceptibility <- all_traits$traits %>%
  filter(trait_name == "myrtle_rust_susceptibility") %>%
  select(taxon_name, myrtle_rust_susceptibility = value) %>%
  group_by(taxon_name) %>%
  mutate(myrtle_rust_susceptibility = paste0(myrtle_rust_susceptibility, collapse = " ")) %>%
  ungroup() %>%
  distinct()

myrtle_rust_susceptibility_data <- myrtle_rust_susceptibility %>%
  mutate(
    myrtle_rust_susceptibility_numeric = case_when(
      myrtle_rust_susceptibility == "resistant" ~ 0,
      myrtle_rust_susceptibility == "low resistant" ~ 0.5,
      myrtle_rust_susceptibility == "low" ~ 1,
      myrtle_rust_susceptibility == "medium resistant" ~ 1.5,
      myrtle_rust_susceptibility == "resistant susceptible" ~ 1.5,
      myrtle_rust_susceptibility == "susceptible resistant susceptible" ~ 2,
      myrtle_rust_susceptibility == "low medium" ~ 2,
      myrtle_rust_susceptibility == "high resistant" ~ 2.5,
      myrtle_rust_susceptibility == "medium" ~ 3,
      myrtle_rust_susceptibility == "high low" ~ 3,
      myrtle_rust_susceptibility == "susceptible" ~ 3,
      myrtle_rust_susceptibility == "high medium high resistant" ~ 3,
      myrtle_rust_susceptibility == "low medium high medium resistant high" ~ 3,
      myrtle_rust_susceptibility == "susceptible medium" ~ 3,
      myrtle_rust_susceptibility == "susceptible high resistant" ~ 3,
      myrtle_rust_susceptibility == "high medium" ~ 4,
      myrtle_rust_susceptibility == "high" ~ 5
    )
  ) %>%
  left_join(dispersers, by = "taxon_name") %>%
  left_join(seed_dry_mass, by = "taxon_name") %>%
  left_join(leaf_mass_per_area, by = "taxon_name") %>%
  left_join(fruit_fleshiness, by = "taxon_name") %>%
  left_join(resprouting_capacity, by = "taxon_name")%>%
  left_join(plant_height, by = "taxon_name") %>%
  left_join(leaf_length, by = "taxon_name") %>%
  left_join(leaf_hairs_adult_leaves, by = "taxon_name") %>%
  left_join(leaf_glaucousness, by = "taxon_name") %>%
  left_join(leaf_nitrogen, by = "taxon_name") %>%
  left_join(leaf_phosphorus, by = "taxon_name") %>%
  left_join(resources$APC %>% select(taxon_name = canonical_name, genus, family), by = "taxon_name")
```

#### - check trait correlations

-   identify strong susceptibility-trait correlations for taxa with known susceptibility

-   Note: 

    1. Not considering traits that are known to matter, but are known for so few species to be useless as predictors (constitutive and induced responses to infection; concentration of secondary metabolites in plant); details of surface wax
    2. The traits `leaf_glaucousness` and `leaf_hairiness` are very much expected to matter and this information should be available for sufficient taxa to eventually include it, but currently it is scored for very few taxa
    
- In the output:

    1. a positive coefficient indicates a higher trait value in more susceptible taxa
    2. for numeric traits, the magnitude of the coefficient indicates the change in response variable for a "1 unit" increase in susceptibility, where susceptibility is on a scale of 0--3.
    3. for numeric traits, the magnitude of the coefficient must be intepreted in conjunction with knowing the scaling for the response variable - different for each trait; the susceptibility is on a scale of 0--5.

```{r, echo=FALSE, message=FALSE, warning=FALSE}
correlations_with_possible_traits <- tibble(
  trait = NA_character_,
  coeff = NA_character_,
  r2 = NA_character_, 
  p_value = NA_character_,
  n = NA_character_,
)

for (var in c("resprouting_capacity", "seed_dry_mass", "leaf_mass_per_area", "fruit_fleshiness", "plant_height", "leaf_length", "leaf_glaucousness", "leaf_hairs_adult_leaves", "leaf_N_per_dry_mass", "leaf_P_per_dry_mass")) {
  
  data_tmp <- myrtle_rust_susceptibility_data %>% filter(!is.na(myrtle_rust_susceptibility_data[[var]]),
                                         !is.na(myrtle_rust_susceptibility_numeric))
  
  linearmodel_var <- lm(data_tmp[[var]] ~ myrtle_rust_susceptibility_numeric , data = data_tmp)
  
  summary(linearmodel_var)[4] %>% as.data.frame() %>% select(4) -> p
  summary(linearmodel_var)[4] %>% as.data.frame() %>% select(1) -> coeff
  
  new_row <- c(
    trait = var, 
    r2= round(summary(linearmodel_var)$r.squared,4), 
    p_value = round(p[2,1],4),
    coeff = round(coeff[2,1],3),
    n = nrow(data_tmp)
      ) %>% 
    t() %>%
    as.data.frame()
  
  correlations_with_possible_traits <- correlations_with_possible_traits %>%
    bind_rows(new_row)
}

myrtlerust_kable_table <- correlations_with_possible_traits %>% 
  arrange(-as.numeric(r2)) %>% 
  filter(!is.na(trait)) %>% 
  kableExtra::kable(caption = "Correlation between myrtle rust susceptibililty and trait value, for species with known susceptibility")

kableExtra::kable_classic(myrtlerust_kable_table) %>%
  kableExtra::kable_styling(full_width = FALSE)
```

### How important is taxonomy? (vs traits...)

considering whether genus matters as much as - or more than traits

- less clear than correlation between family and phytophthora susceptibility, but certainly there are some genera where all species tested are susceptible and others where there are some resistant species and many partially resistant species

```{r, echo=FALSE, warning=FALSE, message=FALSE}
by_genus <- myrtle_rust_susceptibility_data %>%
  filter(!is.na(myrtle_rust_susceptibility_numeric)) %>%
  group_by(genus) %>%
  mutate(
    myrtle_rust_susceptibility_numeric = mean(myrtle_rust_susceptibility_numeric),
    taxa_scored_per_genus = n()
    ) %>%
  ungroup() %>%
  distinct(genus, taxa_scored_per_genus, myrtle_rust_susceptibility_numeric) %>%
  filter(taxa_scored_per_genus > 3, !is.na(genus)) %>%
  arrange(-myrtle_rust_susceptibility_numeric)

genus_histograms <- myrtle_rust_susceptibility_data %>%
  filter(genus %in% by_genus$genus) %>%
  filter(!is.na(myrtle_rust_susceptibility_numeric)) %>%
  left_join(by_genus %>% select(genus, taxa_scored_per_genus)) %>%
  group_by(genus, myrtle_rust_susceptibility_numeric) %>%
  mutate(
    prop_taxa = n() / taxa_scored_per_genus,
    count_taxa = n()
    ) %>%
  ungroup() %>%
  distinct(genus, myrtle_rust_susceptibility_numeric, prop_taxa, count_taxa, taxa_scored_per_genus) %>%
  arrange(genus, myrtle_rust_susceptibility_numeric) %>%
  mutate(
    genus2 = paste0(genus, " (n=", taxa_scored_per_genus,")")
  )

ggplot(data = genus_histograms) +
  geom_col(aes(x = myrtle_rust_susceptibility_numeric, y = prop_taxa), width = .9) +
  facet_wrap(~genus2) +
  theme_minimal() +
  theme(
    axis.line.x.bottom = element_line(),
    axis.line.y.left = element_line()
  ) +
  ylab("prop. of taxa tested") +
  xlab("myrtle rust susceptibility score (higher = more susceptible)")
```


### Assign risks to all taxa

- first steps are based on taxonomy and habitat: 
  1. only Myrtaceae are susceptible
  2. only taxa that live in "wet" environments are susceptible

  *ISSUE*: How to score taxa where habitat information isn't known; currently have data for ~50% of Myrtaceae. Right now we are taking the conservative approach and scoring all those species as being susceptible.

- second steps will be to adjust these binary susceptibilities based on traits
  1. need to decide on r2 threshold, below which the uncertainty is too great to include (possibly true for all traits where we have data!)
  2. there are additional traits which might well be important, but need to bolster their coverage in database to be certain: **leaf glaucousness**, **leaf wax content**, **leaf hairiness**

```{r, warning=FALSE, message=FALSE}
myrtle_rust_assigned_risk <- resources$APC %>% 
  filter(taxonomic_status == "accepted") %>%
  filter(taxon_rank %in% c("species", "subspecies", "variety")) %>%
  select(taxon_name = canonical_name, genus, family, taxon_distribution) %>%
  left_join(habitat, by = "taxon_name") %>%
  left_join(habitat_moisture, by = "taxon_name")

myrtle_rust_assigned_risk <- myrtle_rust_assigned_risk %>%
  mutate(
    susceptibility_step_1 = ifelse(family == "Myrtaceae", 1, 0),
    susceptibility_step_2 = ifelse(!is.na(habitat) | !is.na(habitat_moisture), 0, NA), # yes habitat vs. no habitat info available
    susceptibility_step_2 = ifelse(!is.na(habitat) & 
                                    (str_detect(habitat, "rainforest") | #switch 0 to 1 for wet site species
                                     str_detect(habitat, "stream") | 
                                     str_detect(habitat, "wet") | 
                                     str_detect(habitat, "aquatic")| 
                                     str_detect(habitat, "bog") | 
                                     str_detect(habitat, "swamp")), 
                                      1, susceptibility_step_2),
    susceptibility_step_2 = ifelse(!is.na(habitat_moisture) &
                                    (str_detect(habitat_moisture, "wet") | 
                                     str_detect(habitat_moisture, "moist") | 
                                     str_detect(habitat_moisture, "damp")), 
                                      1, susceptibility_step_2),
  # merge info for taxonomy & habitat
  susceptibility_binary = ifelse(susceptibility_step_1 == 1 & (susceptibility_step_2 == 1| is.na(susceptibility_step_2)), 1, 0)
  )
```

# Goats

### Are any traits good predictors?

- Check if trait correlations exist for taxa where palatability/forage preference/toxicity is known.

- For goats, there are no lists of species that goats avoid -except linked already to specific traits
- For instance, there is a list of 360 species growing in arid Australia, indicating their toxicity to goats; same species have palatibility values
- Goats are known to eat "spiny acacias" (multiple references to this), but presumably the most spine-protected plants are less susceptible?
- Trees are resistant as adults, especially if they have thick bark (little data), but not as seedlings
- Herbs much less impacted than shrubs, grasses (set of numbers below, but other references)
- Succulence

#### - create dataframe
```{r, results='hide', message=FALSE, warning=FALSE}
goat_susceptibility <- plant_goat_palatability %>%
  select(-genus) %>%
  left_join(resources$APC %>% select(family, genus, taxon_name = canonical_name) %>% distinct(), by = "taxon_name") %>%
  group_by(taxon_name) %>%
  mutate(
    plant_goat_palatability  = mean(plant_goat_palatability , na.rm = T)) %>% 
  ungroup() %>%
  distinct() %>% 
  left_join(leaf_water_content_per_area, by = "taxon_name") %>%
  left_join(life_history, by = "taxon_name") %>%
  left_join(plant_growth_form, by = "taxon_name") %>%
  left_join(leaf_glaucousness, by = "taxon_name") %>%
  left_join(leaf_hairs_adult_leaves, by = "taxon_name") %>%
  left_join(leaf_mass_per_area, by = "taxon_name") %>%
  left_join(resprouting_capacity, by = "taxon_name") %>%
  left_join(leaf_phosphorus, by = "taxon_name") %>%
  left_join(leaf_nitrogen, by = "taxon_name") %>%
  left_join(nitrogen_fixing, by = "taxon_name") %>%
  left_join(leaf_length, by = "taxon_name") %>%
  left_join(plant_height, by = "taxon_name") %>%
  left_join(plant_spinescence, by = "taxon_name")
```


#### - check for trait correlations

- The two strongest correlations below don't make sense:
  1.  Nitrogen fixing is coming out as a strong negative correlation because all members of the genus Swainsona mapped in as toxic - and all are N-fixers.
  2.  Succulence (`leaf_water_content_per_area` ) should be positively correlated with palatability, but only scored for 4 species and happens to come out as a strong negative correlation
  
- strongest believable association is for leaf P

- `plant_spinescence` comes out as a very non-significant correlation. It would be good to manually gap fill this, but there are lots of very well-defended species with moderate to high palatability scores, so not expecting it to come out as significant. 

```{r, echo=FALSE, message=FALSE, warning=FALSE}
correlations_with_possible_traits <- tibble(
  trait = NA_character_,
  coeff = NA_character_,
  r2 = NA_character_, 
  p_value = NA_character_,
  n = NA_character_,
)

for (var in c("life_history", "nitrogen_fixing", "resprouting_capacity", "leaf_mass_per_area", "plant_height", "leaf_length", "leaf_glaucousness", "leaf_hairs_adult_leaves", "leaf_N_per_dry_mass", "leaf_P_per_dry_mass", "plant_spinescence", "leaf_water_content_per_area", "plant_growth_form")) {
  
  data_tmp <- goat_susceptibility %>% filter(!is.na(goat_susceptibility[[var]]),
                                         !is.na(plant_goat_palatability))
  
  linearmodel_var <- lm(data_tmp[[var]] ~ plant_goat_palatability , data = data_tmp)
  
  summary(linearmodel_var)[4] %>% as.data.frame() %>% select(4) -> p
  summary(linearmodel_var)[4] %>% as.data.frame() %>% select(1) -> coeff
  
  new_row <- c(
    trait = var, 
    r2= round(summary(linearmodel_var)$r.squared,4), 
    p_value = round(p[2,1],4),
    coeff = round(coeff[2,1],3),
    n = nrow(data_tmp)
      ) %>% 
    t() %>%
    as.data.frame()
  
  correlations_with_possible_traits <- correlations_with_possible_traits %>%
    bind_rows(new_row)
}

correlations_with_possible_traits <- correlations_with_possible_traits %>% 
  arrange(-as.numeric(r2)) %>% 
  filter(!is.na(trait))


goat_kable_table <- correlations_with_possible_traits %>% kableExtra::kable(caption = "Correlation between goat palatability and trait value, for species with known susceptibility")

kableExtra::kable_classic(goat_kable_table) %>%
  kableExtra::kable_styling(full_width = FALSE)
```

- Although plant growth form didn't come out as important in the correlations - other data suggest herbs less impacted by goats than graminoids or shrubs and this should be taken into account with risk scores

```{r, echo=FALSE, warning=FALSE, message=FALSE}
Lu_1988 <- read_csv("datasets_from_manuscripts/Lu_1988.csv") %>% 
  group_by(growth_form) %>% 
  mutate(goats_relative_preference = mean(goats_relative_preference)) %>% 
  ungroup() %>% 
  distinct(growth_form, goats_relative_preference)
```

# C4 tropical grasses



# Regeneration of populations

### Do threatened species have worse dispersal, longer lifespans, etc?

- Simple answer is NO. There is no difference in any of the traits measured between threatened vs other species
- It means that for understanding species regeneration potential, each species' trait values need to be considered - no generalisations.

```{r, echo=FALSE, warning=FALSE, message=FALSE}
all_taxa <- resources$APC %>% 
  filter(taxonomic_status == "accepted") %>%
  filter(taxon_rank %in% c("species", "subspecies", "variety")) %>%
  select(taxon_name = canonical_name, family, genus, taxon_distribution)

species_that_are_threatened <- (all_traits %>%
  extract_trait("threatened_species_listing_status"))$traits %>%
  select(taxon_name, threatened_status = value)

all_taxa <- all_taxa %>%
  left_join(species_that_are_threatened, by = "taxon_name") %>%
  mutate(threatened = ifelse(!is.na(threatened_status), 1, 0)) %>%
  left_join(dispersers, by = "taxon_name") %>%
  left_join(life_history, by = "taxon_name") %>%
  left_join(seed_dry_mass, by = "taxon_name") %>%
  left_join(leaf_mass_per_area, by = "taxon_name") %>%
  left_join(fruit_fleshiness, by = "taxon_name") %>%
  left_join(resprouting_capacity, by = "taxon_name")

correlations_with_possible_traits <- tibble(
  trait = NA_character_,
  coeff = NA_character_,
  r2 = NA_character_, 
  p_value = NA_character_,
  n = NA_character_,
)

for (var in c("life_history", "dispersers_score", "resprouting_capacity", "seed_dry_mass", "fruit_fleshiness", "leaf_mass_per_area")) {
  
  data_tmp <- all_taxa %>% filter(!is.na(all_taxa[[var]]))
  
  linearmodel_var <- lm(data_tmp[[var]] ~ threatened , data = data_tmp)
  
  summary(linearmodel_var)[4] %>% as.data.frame() %>% select(4) -> p
  summary(linearmodel_var)[4] %>% as.data.frame() %>% select(1) -> coeff
  
  new_row <- c(
    trait = var, 
    r2= round(summary(linearmodel_var)$r.squared,4), 
    p_value = round(p[2,1],4),
    coeff = round(coeff[2,1],3),
    n = nrow(data_tmp)
      ) %>% 
    t() %>%
    as.data.frame()
  
  correlations_with_possible_traits <- correlations_with_possible_traits %>%
    bind_rows(new_row)
}

correlations_with_possible_traits <- correlations_with_possible_traits %>% 
  arrange(-as.numeric(r2)) %>% 
  filter(!is.na(trait))


threatened_kable_table <- correlations_with_possible_traits %>% kableExtra::kable(caption = "Correlation between threat status and `regeneration` trait value")

kableExtra::kable_classic(threatened_kable_table) %>%
  kableExtra::kable_styling(full_width = FALSE)
```

